<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listado de Mascotas</title>
  <meta name="theme-color" content="#22c55e" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { background: #f0fdf4; }
  </style>
</head>
<body class="min-h-screen p-4">
  <main class="w-full max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-green-700 mb-6 text-center">üêæ Listado de Mascotas</h1>
    <div id="pet-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>

    <section id="state-loading" class="text-center py-10">
      <p class="text-gray-600">Cargando listado de mascotas...</p>
    </section>

    <section id="state-error" class="hidden text-center py-10">
      <h2 class="text-xl font-bold text-red-600">Error al cargar el listado</h2>
      <p id="err-msg" class="text-gray-600 mt-2"></p>
    </section>
  </main>

  <script>
    const EXCEL_URL = "mascotas.xlsx";

    const $ = (id) => document.getElementById(id);
    const show = (id) => $(id).classList.remove("hidden");
    const hide = (id) => $(id).classList.add("hidden");

    function normalize(str) {
      return (str || "").toString().trim();
    }

    function buildPetObject(row) {
      const normalizedRow = {};
      for (const key in row) {
        const normalizedKey = key.normalize("NFD").replace(/[ÃÄ-\u036f]/g, "").trim().toLowerCase();
        normalizedRow[normalizedKey] = row[key];
      }
      return {
        id: normalizedRow["idmascota"] || "",
        nombre: normalizedRow["nombre"] || "Mascota",
        foto: normalizedRow["foto"] || "https://placehold.co/256x256?text=Mascota",
        descripcion: normalizedRow["descripcion"] || "",
      };
    }

    async function fetchExcel() {
      const res = await fetch(EXCEL_URL);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const arrayBuffer = await res.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      return XLSX.utils.sheet_to_json(sheet);
    }

    function renderList(pets) {
      const container = $("pet-list");
      container.innerHTML = "";

      pets.forEach((pet) => {
        const card = document.createElement("a");
        card.href = `index.html?id=${encodeURIComponent(pet.id)}`;
        card.className =
          "block bg-white rounded-2xl shadow hover:shadow-lg transition overflow-hidden";
        card.innerHTML = `
          <img src="${pet.foto}" alt="Foto de ${pet.nombre}" class="w-full h-40 object-cover">
          <div class="p-4">
            <h2 class="text-lg font-bold text-green-700">${pet.nombre}</h2>
            <p class="text-sm text-gray-600">${pet.descripcion}</p>
          </div>
        `;
        container.appendChild(card);
      });

      hide("state-loading");
    }

    async function init() {
      try {
        const rows = await fetchExcel();
        const pets = rows.map(buildPetObject);
        renderList(pets);
      } catch (e) {
        console.error(e);
        hide("state-loading");
        $("err-msg").textContent = String(e.message || e);
        show("state-error");
      }
    }

    init();
  </script>
</body>
</html>
